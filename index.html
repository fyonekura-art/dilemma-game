<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>囚人のジレンマ実習</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; text-align: center; padding: 20px; color: #333; }
        .card { background: white; max-width: 400px; margin: auto; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nickname { font-size: 1.2rem; font-weight: bold; color: #3498db; margin-bottom: 10px; }
        .status-msg { background: #eee; padding: 15px; border-radius: 10px; margin: 20px 0; min-height: 50px; }
        .btn-group { display: flex; gap: 10px; flex-direction: column; }
        button { padding: 20px; font-size: 1.2rem; border: none; border-radius: 10px; cursor: pointer; color: white; transition: 0.2s; }
        .btn-silent { background: #27ae60; } /* 自白しない */
        .btn-confess { background: #e74c3c; } /* 自白する */
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table td { border: 1px solid #ddd; padding: 8px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="card">
    <div id="setup-area">
        <h2>参加準備</h2>
        <p>下のボタンを押すとランダムな名前で参加します</p>
        <button style="background:#3498db; width:100%;" onclick="joinGame()">ゲームに参加する</button>
    </div>

    <div id="game-area" style="display:none;">
        <div class="nickname">名前: <span id="my-name">---</span></div>
        <div id="room-info" style="font-size:0.8rem; color:#666;"></div>
        
        <div class="status-msg" id="status-text">先生が開始するまでお待ちください...</div>

        <div id="action-buttons" class="btn-group" style="display:none;">
            <button class="btn-silent" onclick="submitChoice('自白しない')">自白しない</button>
            <button class="btn-confess" onclick="submitChoice('自白する')">自白する</button>
        </div>

        <div id="result-area" style="display:none;">
            <h3>結果</h3>
            <p id="round-result-text"></p>
            <table class="result-table">
                <tr><td>自分</td><td id="res-my-choice"></td><td id="res-my-penalty"></td></tr>
                <tr><td>相手</td><td id="res-opp-choice"></td><td id="res-opp-penalty"></td></tr>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_lw01IiPvvBjinfw2UZ9NuqqurGm5yIw",
        authDomain: "prisonergame-27a20.firebaseapp.com",
        databaseURL: "https://prisonergame-27a20-default-rtdb.firebaseio.com",
        projectId: "prisonergame-27a20",
        storageBucket: "prisonergame-27a20.firebasestorage.app",
        messagingSenderId: "456926790656",
        appId: "1:456926790656:web:7e59a56e6a68ed612444e5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myId, myName, myRoom, myRole;

    const adjs = ["勇敢な", "慎重な", "空飛ぶ", "腹ペコな", "光り輝く", "謎の"];
    const animals = ["ライオン", "ペンギン", "ハムスター", "パンダ", "キツネ", "イルカ"];

    function joinGame() {
        myId = "user_" + Math.random().toString(36).substr(2, 9);
        myName = adjs[Math.floor(Math.random()*adjs.length)] + animals[Math.floor(Math.random()*animals.length)];
        
        db.ref('presence/' + myId).set({ name: myName, status: 'waiting' });
        // ブラウザを閉じたら削除
        db.ref('presence/' + myId).onDisconnect().remove();

        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        document.getElementById('my-name').innerText = myName;

        listenGame();
    }

    function listenGame() {
        // 自分の部屋割り当てを監視
        db.ref(`presence/${myId}`).on('value', snap => {
            const data = snap.val();
            if (data && data.roomId) {
                myRoom = data.roomId;
                myRole = data.playerNum;
                document.getElementById('room-info').innerText = "対戦準備完了";
            }
        });

        // 進行フェーズを監視
        db.ref('gameMaster/phase').on('value', phase => {
            const statusText = document.getElementById('status-text');
            const actionBtns = document.getElementById('action-buttons');
            const resultArea = document.getElementById('result-area');

            if (phase === 'round1' || phase === 'round2') {
                statusText.innerText = phase === 'round1' ? "【第1回戦】選択してください" : "【第2回戦】相手の手を予想して選択！";
                actionBtns.style.display = 'flex';
                resultArea.style.display = 'none';
                
                // 相手が既に入力したかチェック（2回戦のみ前の結果表示など）
                watchRoom(phase);
            }
        });
    }

    function submitChoice(choice) {
        if (!myRoom) return;
        db.ref('gameMaster/phase').once('value', snap => {
            const phase = snap.val();
            db.ref(`rooms/${myRoom}/${phase}/${myRole}_choice`).set(choice);
            document.getElementById('action-buttons').style.display = 'none';
            document.getElementById('status-text').innerText = "相手の入力を待っています...";
        });
    }

    function watchRoom(phase) {
        db.ref(`rooms/${myRoom}/${phase}`).on('value', snap => {
            const data = snap.val();
            if (data && data.p1_choice && data.p2_choice) {
                showResult(data.p1_choice, data.p2_choice);
            }
        });
    }

    function showResult(p1c, p2c) {
        const myChoice = (myRole === 'p1') ? p1c : p2c;
        const oppChoice = (myRole === 'p1') ? p2c : p1c;
        let myPen = 0, oppPen = 0;

        if (myChoice === '自白しない' && oppChoice === '自白しない') { myPen = 2; oppPen = 2; }
        else if (myChoice === '自白しない' && oppChoice === '自白する') { myPen = 10; oppPen = 0; }
        else if (myChoice === '自白する' && oppChoice === '自白しない') { myPen = 0; oppPen = 10; }
        else { myPen = 5; oppPen = 5; }

        document.getElementById('status-text').innerText = "結果が出ました！";
        document.getElementById('result-area').style.display = 'block';
        document.getElementById('res-my-choice').innerText = myChoice;
        document.getElementById('res-my-penalty').innerText = "懲役 " + myPen + "年";
        document.getElementById('res-opp-choice').innerText = oppChoice;
        document.getElementById('res-opp-penalty').innerText = "懲役 " + oppPen + "年";
    }
</script>
</body>
</html>