<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>囚人のジレンマ実習</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 25px; border-radius: 15px; max-width: 400px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        button { width: 100%; padding: 18px; margin: 10px 0; font-size: 1.2rem; border-radius: 10px; border: none; cursor: pointer; color: white; font-weight: bold; }
        #res { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; display: none; margin-top: 20px; border: 1px solid #bee5eb; }
        .name-label { font-size: 1.1rem; color: #3498db; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="card">
        <div id="setup">
            <h2>囚人のジレンマ実習</h2>
            <button style="background:#3498db;" onclick="join()">ゲームに参加する</button>
        </div>

        <div id="game" style="display:none;">
            <div class="name-label">名前: <b id="display-name">...</b></div>
            <div id="room-st" style="background:#eee; padding:10px; border-radius:5px; margin-bottom:15px; font-weight:bold;">待機中...</div>
            
            <div id="btns" style="display:none;">
                <button style="background:#27ae60;" onclick="sendChoice('自白しない')">自白しない</button>
                <button style="background:#e74c3c;" onclick="sendChoice('自白する')">自白する</button>
            </div>
            <div id="res"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_lw01IiPvvBjinfw2UZ9NuqqurGm5yIw",
        authDomain: "prisonergame-27a20.firebaseapp.com",
        databaseURL: "https://prisonergame-27a20-default-rtdb.firebaseio.com",
        projectId: "prisonergame-27a20",
        storageBucket: "prisonergame-27a20.firebasestorage.app",
        messagingSenderId: "456926790656",
        appId: "1:456926790656:web:7e59a56e6a68ed612444e5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myId, myRoom, myRole;

    const adjs = ["勇敢な", "慎重な", "冷静な", "強欲な", "謎の", "素早い", "賢い", "輝く", "忍耐強い", "大胆な", "心優しい", "自由な", "鋭い", "静かな", "巨大な", "小さな", "誇り高き", "陽気な", "孤独な", "情熱的な"];
    const animals = ["ライオン", "フクロウ", "キツネ", "ペンギン", "トラ", "イルカ", "ウサギ", "クマ", "ワシ", "パンダ", "リス", "カメ", "オオカミ", "キリン", "ゾウ", "サル", "コアラ", "カンガルー", "クジラ", "シカ"];

    window.onload = function() {
        const savedId = localStorage.getItem('prisoner_myId');
        if (savedId) { myId = savedId; restoreSession(); }
    };

    function join() {
        myId = "u_" + Math.random().toString(36).substr(2, 5);
        localStorage.setItem('prisoner_myId', myId);
        const name = adjs[Math.floor(Math.random()*adjs.length)] + animals[Math.floor(Math.random()*animals.length)];
        db.ref('presence/' + myId).set({ name: name }).then(() => startFlow(name));
    }

    function restoreSession() {
        db.ref('presence/' + myId).once('value', s => {
            if (s.val()) startFlow(s.val().name);
            else { localStorage.removeItem('prisoner_myId'); document.getElementById('setup').style.display = 'block'; }
        });
    }

    function startFlow(name) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        document.getElementById('display-name').innerText = name;

        db.ref('presence/' + myId).on('value', s => {
            if(s.val()?.roomId) {
                myRoom = s.val().roomId;
                myRole = s.val().playerNum;
            }
        });

        db.ref('gameMaster/phase').on('value', s => {
            const phase = s.val();
            const btnArea = document.getElementById('btns');
            const resArea = document.getElementById('res');
            if (phase === 'round1' || phase === 'round2') {
                btnArea.style.display = 'block';
                resArea.style.display = 'none';
                document.getElementById('room-st').innerText = (phase === 'round1' ? "【1回戦】" : "【2回戦】") + " 受付中";
                watchResult(phase);
            } else {
                btnArea.style.display = 'none';
                document.getElementById('room-st').innerText = "次の合図を待っています...";
            }
        });
    }

    function sendChoice(choice) {
        db.ref('gameMaster/phase').once('value', s => {
            const ph = s.val();
            db.ref(`rooms/${myRoom}/${ph}/${myRole}_choice`).set(choice);
            // 送信直後に「相手待ち」にするが、結果があればwatchResultで上書きされる
            document.getElementById('btns').style.display = 'none';
            document.getElementById('room-st').innerText = "回答完了！";
        });
    }

    function watchResult(phase) {
        db.ref(`rooms/${myRoom}/${phase}`).on('value', s => {
            const d = s.val();
            // 両方の回答が揃った瞬間だけ表示を切り替える
            if (d && d.p1_choice && d.p2_choice) {
                const myC = (myRole === 'p1') ? d.p1_choice : d.p2_choice;
                const opC = (myRole === 'p1') ? d.p2_choice : d.p1_choice;
                const resArea = document.getElementById('res');
                resArea.style.display = 'block';
                resArea.innerHTML = `<b>結果</b><br>自分: ${myC}<br>相手: ${opC}`;
                document.getElementById('room-st').innerText = "この戦いは終了しました";
                document.getElementById('btns').style.display = 'none';
            }
        });
    }
</script>
</body>
</html>
