<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>【管理】囚人のジレンマ実習 - 完成版</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; padding: 20px; }
        .controls { background: white; color: #333; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .room-card { background: #ecf0f1; color: #333; padding: 10px; border-radius: 5px; border-left: 5px solid #bdc3c7; font-size: 0.85rem; }
        .room-card.active { border-left-color: #27ae60; background: #fff; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .done { background: #27ae60; }
        .yet { background: #bdc3c7; border: 1px solid #7f8c8d; }
        button { padding: 12px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; color: white; margin: 5px; font-weight: bold; }
        .btn-blue { background: #3498db; }
        .btn-green { background: #27ae60; }
        .btn-purple { background: #8e44ad; }
        .btn-red { background: #e74c3c; }
    </style>
</head>
<body>
    <h1>授業管理パネル</h1>
    <p>接続中の生徒: <b id="student-count">0</b>人 | 現在の状態: <b id="current-phase">待機中</b></p>
    
    <div class="controls">
        <button class="btn-green" onclick="updatePhase('round1')">【第1回戦】開始 (新マッチング)</button>
        <button class="btn-purple" onclick="updatePhase('round2')">【第2回戦】開始 (席替えマッチング)</button>
        <button class="btn-red" onclick="resetGame()">全データをリセット</button>
    </div>

    <h3>各ルームの進捗 (●回答済 / ○未回答)</h3>
    <div id="room-list" class="room-grid"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_lw01IiPvvBjinfw2UZ9NuqqurGm5yIw",
        authDomain: "prisonergame-27a20.firebaseapp.com",
        databaseURL: "https://prisonergame-27a20-default-rtdb.firebaseio.com",
        projectId: "prisonergame-27a20",
        storageBucket: "prisonergame-27a20.firebasestorage.app",
        messagingSenderId: "456926790656",
        appId: "1:456926790656:web:7e59a56e6a68ed612444e5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref('presence').on('value', s => document.getElementById('student-count').innerText = s.numChildren());
    db.ref('gameMaster/phase').on('value', s => document.getElementById('current-phase').innerText = s.val() || "待機中");

    db.ref('rooms').on('value', snapshot => {
        const rooms = snapshot.val();
        const listArea = document.getElementById('room-list');
        listArea.innerHTML = "";
        if(!rooms) return;

        db.ref('gameMaster/phase').once('value', pSnap => {
            const phase = pSnap.val();
            Object.keys(rooms).forEach(rId => {
                const room = rooms[rId];
                const p1_done = room[phase]?.p1_choice ? "done" : "yet";
                const p2_done = room[phase]?.p2_choice ? "done" : "yet";
                const card = document.createElement('div');
                card.className = "room-card" + (room[phase] ? " active" : "");
                card.innerHTML = `<b>${rId.toUpperCase()}</b><br>
                    <span class="status-dot ${p1_done}"></span>P1 
                    <span class="status-dot ${p2_done}"></span>P2`;
                listArea.appendChild(card);
            });
        });
    });

    async function updatePhase(phase) {
        const snapshot = await db.ref('presence').once('value');
        const students = snapshot.val();
        if (!students) return alert("生徒が接続していません");
        
        const ids = Object.keys(students);
        ids.sort(() => Math.random() - 0.5);

        const rooms = {};
        for (let i = 0; i < ids.length; i += 2) {
            const rId = "room_" + (Math.floor(i/2) + 1);
            const p1 = ids[i];
            const p2 = ids[i+1] || "CPU";
            
            rooms[rId] = {
                p1, p2,
                [phase]: { p1_choice: null, p2_choice: (p2 === "CPU" ? "自白しない" : null) }
            };
            db.ref(`presence/${p1}`).update({ roomId: rId, playerNum: 'p1' });
            if(p2 !== "CPU") db.ref(`presence/${p2}`).update({ roomId: rId, playerNum: 'p2' });
        }

        await db.ref('rooms').set(rooms);
        await db.ref('gameMaster').update({ phase: phase });
    }

    function resetGame() { if(confirm("全データを消去して待機状態に戻しますか？")) db.ref('/').set({gameMaster:{phase:'waiting'}}); }
</script>
</body>
</html>
