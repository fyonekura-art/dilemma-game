<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>【管理画面】囚人のジレンマ実習</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #34495e; padding: 20px; border-radius: 10px; }
        .stats-box { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: #1abc9c; padding: 15px; border-radius: 8px; text-align: center; }
        .controls { background: #ecf0f1; color: #333; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        button { padding: 10px 20px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; background: #3498db; color: white; margin: 5px; }
        button:hover { opacity: 0.8; }
        .room-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .room-card { background: #95a5a6; padding: 10px; border-radius: 5px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>授業管理パネル</h1>
    
    <div class="stats-box">
        <div class="stat-card">接続中の生徒<br><span id="student-count" style="font-size: 2rem;">0</span>人</div>
        <div class="stat-card" style="background: #e67e22;">現在のフェーズ<br><span id="current-phase" style="font-size: 1.2rem;">待機中</span></div>
    </div>

    <div class="controls">
        <h3>進行コントロール</h3>
        <button onclick="startMatching()">1. マッチング実行</button>
        <button onclick="updatePhase('round1')" style="background: #27ae60;">2. 第1回戦 開始</button>
        <button onclick="updatePhase('round2')" style="background: #27ae60;">3. 第2回戦 開始</button>
        <button onclick="resetGame()" style="background: #e74c3c;">全リセット</button>
    </div>

    <h3>対戦状況（Room一覧）</h3>
    <div id="room-list" class="room-list"></div>
</div>

<script>
   // Your web app's Firebase configuration

// For Firebase JS SDK v7.20.0 and later, measurementId is optional

const firebaseConfig = {

  apiKey: "AIzaSyD_lw01IiPvvBjinfw2UZ9NuqqurGm5yIw",

  authDomain: "prisonergame-27a20.firebaseapp.com",

  databaseURL: "https://prisonergame-27a20-default-rtdb.firebaseio.com",

  projectId: "prisonergame-27a20",

  storageBucket: "prisonergame-27a20.firebasestorage.app",

  messagingSenderId: "456926790656",

  appId: "1:456926790656:web:7e59a56e6a68ed612444e5",

  measurementId: "G-06PQ22W9JR"

};

    // ---------------------------------------------------

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 接続中の生徒を監視
    db.ref('presence').on('value', (snapshot) => {
        const students = snapshot.val() || {};
        document.getElementById('student-count').innerText = Object.keys(students).length;
    });

    // 進行状況の監視
    db.ref('gameMaster').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        document.getElementById('current-phase').innerText = data.phase || "待機中";
    });

    // フェーズ更新関数
    function updatePhase(phaseName) {
        db.ref('gameMaster').update({ phase: phaseName });
    }

    // マッチングロジック
    function startMatching() {
        db.ref('presence').once('value', (snapshot) => {
            const students = snapshot.val();
            if (!students) return alert("生徒がまだ接続していません");
            
            const studentIds = Object.keys(students);
            // シャッフル
            for (let i = studentIds.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [studentIds[i], studentIds[j]] = [studentIds[j], studentIds[i]];
            }

            const rooms = {};
            for (let i = 0; i < studentIds.length; i += 2) {
                const roomId = "room_" + (i / 2 + 1);
                const p1 = studentIds[i];
                const p2 = studentIds[i+1] || "CPU"; // 奇数の場合
                
                rooms[roomId] = {
                    p1: p1,
                    p2: p2,
                    round1: { p1_choice: null, p2_choice: (p2==="CPU" ? "自白しない" : null) },
                    round2: { p1_choice: null, p2_choice: (p2==="CPU" ? "自白しない" : null) }
                };
                
                // 生徒側に自分の部屋を通知
                db.ref(`presence/${p1}`).update({ roomId: roomId, playerNum: 'p1' });
                if (p2 !== "CPU") {
                    db.ref(`presence/${p2}`).update({ roomId: roomId, playerNum: 'p2' });
                }
            }
            db.ref('rooms').set(rooms);
            updatePhase('matched');
            alert("マッチング完了！");
        });
    }

    function resetGame() {
        if(confirm("全てのデータをリセットしますか？")) {
            db.ref('/').remove();
            updatePhase('waiting');
        }
    }
</script>
</body>
</html>