<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã€ç®¡ç†ã€‘å›šäººã®ã‚¸ãƒ¬ãƒ³ãƒ - åˆ†æãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ä»˜</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; padding: 20px; }
        .controls { background: white; color: #333; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .section { background: #34495e; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .room-card { background: #ecf0f1; color: #333; padding: 8px; border-radius: 5px; border-left: 5px solid #bdc3c7; font-size: 0.8rem; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .done { background: #27ae60; }
        .yet { background: #bdc3c7; border: 1px solid #7f8c8d; }
        button { padding: 12px 18px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; color: white; margin: 5px; font-weight: bold; }
        .btn-green { background: #27ae60; }
        .btn-purple { background: #8e44ad; }
        .btn-red { background: #e74c3c; }
        ul { padding-left: 20px; font-size: 0.9rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; color: white; }
        th, td { border: 1px solid #5d6d7e; padding: 8px; text-align: left; }
        th { background: #2c3e50; }
    </small></style>
</head>
<body>
    <h1>æˆæ¥­ç®¡ç†ãƒ‘ãƒãƒ« (åˆ†æãƒ¢ãƒ¼ãƒ‰)</h1>
    <p>æ¥ç¶šæ•°: <b id="student-count">0</b> | çŠ¶æ…‹: <b id="current-phase">å¾…æ©Ÿä¸­</b></p>
    
    <div class="controls">
        <button class="btn-green" onclick="updatePhase('round1')">ã€1å›æˆ¦ã€‘ãƒãƒƒãƒãƒ³ã‚°ï¼†é–‹å§‹</button>
        <button class="btn-purple" onclick="updatePhase('round2')">ã€2å›æˆ¦ã€‘å†ãƒãƒƒãƒãƒ³ã‚°ï¼†é–‹å§‹</button>
        <button class="btn-red" onclick="resetGame()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="section">
        <h3>ğŸ“Š æ‡²å½¹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãƒ¯ãƒ¼ã‚¹ãƒˆé †ï¼‰</h3>
        <table id="ranking-table">
            <thead><tr><th>é †ä½</th><th>åå‰</th><th>1å›æˆ¦</th><th>2å›æˆ¦</th><th>åˆè¨ˆæ‡²å½¹</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div class="section">
            <h3>ğŸ˜ˆ ãƒ‰ãƒ©ãƒç™ºç”Ÿãƒ­ã‚°</h3>
            <div id="betrayal-log"></div>
        </div>
        <div class="section">
            <h3>ğŸ  å„ãƒ«ãƒ¼ãƒ ã®é€²æ—</h3>
            <div id="room-list" class="room-grid"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_lw01IiPvvBjinfw2UZ9NuqqurGm5yIw",
        authDomain: "prisonergame-27a20.firebaseapp.com",
        databaseURL: "https://prisonergame-27a20-default-rtdb.firebaseio.com",
        projectId: "prisonergame-27a20",
        storageBucket: "prisonergame-27a20.firebasestorage.app",
        messagingSenderId: "456926790656",
        appId: "1:456926790656:web:7e59a56e6a68ed612444e5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let studentNames = {};

    db.ref('presence').on('value', s => {
        studentNames = s.val() || {};
        document.getElementById('student-count').innerText = Object.keys(studentNames).length;
    });

    db.ref('gameMaster/phase').on('value', s => document.getElementById('current-phase').innerText = s.val() || "å¾…æ©Ÿä¸­");

    db.ref('rooms').on('value', snapshot => {
        const rooms = snapshot.val();
        if(!rooms) return;

        const listArea = document.getElementById('room-list');
        const rankingBody = document.querySelector('#ranking-table tbody');
        const logArea = document.getElementById('betrayal-log');
        listArea.innerHTML = "";
        logArea.innerHTML = "";
        
        let playerStats = {}; // IDã”ã¨ã®æ‡²å½¹é›†è¨ˆ
        let logs = { round1: [], round2: [] };

        Object.keys(rooms).forEach(rId => {
            const room = rooms[rId];
            const card = document.createElement('div');
            card.className = "room-card";
            let statusHtml = `<b>${rId}</b><br>`;

            ['round1', 'round2'].forEach(rnd => {
                const game = room[rnd];
                if (!game) return;

                const p1_c = game.p1_choice;
                const p2_c = game.p2_choice;
                statusHtml += `${rnd.slice(-1)}æˆ¦: <span class="status-dot ${p1_c?'done':'yet'}"></span><span class="status-dot ${p2_c?'done':'yet'}"></span><br>`;

                if (p1_c && p2_c) {
                    const calc = (c1, c2) => {
                        if (c1 === "è‡ªç™½ã—ãªã„" && c2 === "è‡ªç™½ã—ãªã„") return 2;
                        if (c1 === "è‡ªç™½ã—ãªã„" && c2 === "è‡ªç™½ã™ã‚‹") return 10;
                        if (c1 === "è‡ªç™½ã™ã‚‹" && c2 === "è‡ªç™½ã—ãªã„") return 0;
                        return 5;
                    };
                    const s1 = calc(p1_c, p2_c);
                    const s2 = calc(p2_c, p1_c);

                    // çµ±è¨ˆåŠ ç®—
                    [room.p1, room.p2].forEach((id, idx) => {
                        if (id === "CPU") return;
                        if (!playerStats[id]) playerStats[id] = { name: studentNames[id]?.name, r1: "-", r2: "-", total: 0 };
                        const score = (idx === 0) ? s1 : s2;
                        playerStats[id][rnd === 'round1' ? 'r1' : 'r2'] = score + "å¹´";
                        playerStats[id].total += score;
                    });

                    // ãƒ­ã‚°ä½œæˆ
                    const n1 = studentNames[room.p1]?.name || "P1";
                    const n2 = room.p2 === "CPU" ? "CPU" : (studentNames[room.p2]?.name || "P2");
                    if (p1_c !== p2_c) {
                        const betrayer = (p1_c === "è‡ªç™½ã™ã‚‹") ? n1 : n2;
                        const victim = (p1_c === "è‡ªç™½ã™ã‚‹") ? n2 : n1;
                        logs[rnd].push(`<li>ğŸ˜ˆ <b>${betrayer}</b> ğŸ˜­ <b>${victim}</b></li>`);
                    }
                }
            });
            card.innerHTML = statusHtml;
            listArea.appendChild(card);
        });

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        const sorted = Object.values(playerStats).sort((a, b) => b.total - a.total);
        rankingBody.innerHTML = sorted.map((p, i) => `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.r1}</td><td>${p.r2}</td><td><b>${p.total}å¹´</b></td></tr>`).join('');
        
        // ãƒ­ã‚°è¡¨ç¤º
        logArea.innerHTML = `<b>1å›æˆ¦:</b><ul>${logs.round1.join('') || "ãªã—"}</ul><b>2å›æˆ¦:</b><ul>${logs.round2.join('') || "ãªã—"}</ul>`;
    });

    async function updatePhase(phase) {
        const snapshot = await db.ref('presence').once('value');
        const students = snapshot.val();
        if (!students) return alert("ç”Ÿå¾’ãŒã„ã¾ã›ã‚“");
        const ids = Object.keys(students).sort(() => Math.random() - 0.5);
        const rooms = {};
        for (let i = 0; i < ids.length; i += 2) {
            const rId = "room_" + (Math.floor(i/2) + 1);
            const p1 = ids[i], p2 = ids[i+1] || "CPU";
            rooms[rId] = { p1, p2, [phase]: { p1_choice: null, p2_choice: (p2 === "CPU" ? "è‡ªç™½ã—ãªã„" : null) } };
            db.ref(`presence/${p1}`).update({ roomId: rId, playerNum: 'p1' });
            if(p2 !== "CPU") db.ref(`presence/${p2}`).update({ roomId: rId, playerNum: 'p2' });
        }
        await db.ref('rooms').set(rooms);
        await db.ref('gameMaster').update({ phase: phase });
    }

    function resetGame() { if(confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) db.ref('/').set({gameMaster:{phase:'waiting'}}); }
</script>
</body>
</html>
