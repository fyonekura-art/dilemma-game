<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã€ç®¡ç†ã€‘å›šäººã®ã‚¸ãƒ¬ãƒ³ãƒ - åˆ†æãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #2c3e50; color: white; padding: 20px; }
        .controls { background: white; color: #333; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .section { background: #34495e; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .room-card { background: #ecf0f1; color: #333; padding: 8px; border-radius: 5px; border-left: 5px solid #bdc3c7; font-size: 0.8rem; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .done { background: #27ae60; }
        .yet { background: #bdc3c7; border: 1px solid #7f8c8d; }
        button { padding: 12px 18px; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; color: white; margin: 5px; font-weight: bold; }
        .btn-green { background: #27ae60; }
        .btn-purple { background: #8e44ad; }
        .btn-red { background: #e74c3c; }
        .btn-gold { background: #f1c40f; color: #333; }
        ul { padding-left: 20px; }
    </style>
</head>
<body>
    <h1>æˆæ¥­ç®¡ç†ãƒ‘ãƒãƒ«</h1>
    <p>æ¥ç¶šæ•°: <b id="student-count">0</b> | çŠ¶æ…‹: <b id="current-phase">å¾…æ©Ÿä¸­</b></p>
    
    <div class="controls">
        <button class="btn-green" onclick="updatePhase('round1')">ã€1å›æˆ¦ã€‘é–‹å§‹</button>
        <button class="btn-purple" onclick="updatePhase('round2')">ã€2å›æˆ¦ã€‘é–‹å§‹</button>
        <button class="btn-gold" onclick="window.open('ranking.html', '_blank')">ğŸ† åˆ¥ã‚¿ãƒ–ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º</button>
        <button class="btn-red" onclick="resetGame()">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div class="section">
            <h3>ğŸ˜ˆ è£åˆ‡ã‚Šç™ºç”Ÿãƒ­ã‚°</h3>
            <div id="betrayal-log"></div>
        </div>
        <div class="section">
            <h3>ğŸ  å„ãƒ«ãƒ¼ãƒ é€²æ—</h3>
            <div id="room-list" class="room-grid"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_lw01IiPvvBjinfw2UZ9NuqqurGm5yIw",
        authDomain: "prisonergame-27a20.firebaseapp.com",
        databaseURL: "https://prisonergame-27a20-default-rtdb.firebaseio.com",
        projectId: "prisonergame-27a20",
        storageBucket: "prisonergame-27a20.firebasestorage.app",
        messagingSenderId: "456926790656",
        appId: "1:456926790656:web:7e59a56e6a68ed612444e5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let studentNames = {};

    db.ref('presence').on('value', s => {
        studentNames = s.val() || {};
        document.getElementById('student-count').innerText = Object.keys(studentNames).length;
    });

    db.ref('gameMaster/phase').on('value', s => document.getElementById('current-phase').innerText = s.val() || "å¾…æ©Ÿä¸­");

    db.ref('rooms').on('value', snapshot => {
        const rooms = snapshot.val();
        if(!rooms) return;
        const listArea = document.getElementById('room-list');
        const logArea = document.getElementById('betrayal-log');
        listArea.innerHTML = "";
        logArea.innerHTML = "";
        let logs = { round1: [], round2: [] };

        Object.keys(rooms).forEach(rId => {
            const room = rooms[rId];
            const card = document.createElement('div');
            card.className = "room-card";
            let statusHtml = `<b>${rId}</b><br>`;

            ['round1', 'round2'].forEach(rnd => {
                const g = room[rnd];
                if (!g) return;
                statusHtml += `${rnd.slice(-1)}æˆ¦: <span class="status-dot ${g.p1_choice?'done':'yet'}"></span><span class="status-dot ${g.p2_choice?'done':'yet'}"></span><br>`;
                if (g.p1_choice && g.p2_choice && g.p1_choice !== g.p2_choice) {
                    const n1 = studentNames[room.p1]?.name || "P1";
                    const n2 = room.p2 === "CPU" ? "CPU" : (studentNames[room.p2]?.name || "P2");
                    const betrayer = (g.p1_choice === "è‡ªç™½ã™ã‚‹") ? n1 : n2;
                    const victim = (g.p1_choice === "è‡ªç™½ã™ã‚‹") ? n2 : n1;
                    logs[rnd].push(`<li>ğŸ˜ˆ<b>${betrayer}</b> ğŸ˜­<b>${victim}</b></li>`);
                }
            });
            card.innerHTML = statusHtml;
            listArea.appendChild(card);
        });
        logArea.innerHTML = `<b>1æˆ¦ç›®:</b><ul>${logs.round1.join('')}</ul><b>2æˆ¦ç›®:</b><ul>${logs.round2.join('')}</ul>`;
    });

    async function updatePhase(phase) {
        const snapshot = await db.ref('presence').once('value');
        const students = snapshot.val();
        if (!students) return alert("ç”Ÿå¾’ãŒã„ã¾ã›ã‚“");
        const ids = Object.keys(students).sort(() => Math.random() - 0.5);
        const oldSnap = await db.ref('rooms').once('value');
        const oldRooms = oldSnap.val() || {};
        const newRooms = (phase === 'round2') ? oldRooms : {};

        for (let i = 0; i < ids.length; i += 2) {
            const rId = "room_" + (Math.floor(i/2) + 1);
            const p1 = ids[i], p2 = ids[i+1] || "CPU";
            const cpuChoice = (Math.random() > 0.5) ? "è‡ªç™½ã—ãªã„" : "è‡ªç™½ã™ã‚‹";
            newRooms[rId] = { ...(newRooms[rId] || {}), p1, p2, [phase]: { p1_choice: null, p2_choice: (p2 === "CPU" ? cpuChoice : null) } };
            db.ref(`presence/${p1}`).update({ roomId: rId, playerNum: 'p1' });
            if(p2 !== "CPU") db.ref(`presence/${p2}`).update({ roomId: rId, playerNum: 'p2' });
        }
        await db.ref('rooms').set(newRooms);
        await db.ref('gameMaster').update({ phase: phase });
    }

    function resetGame() { if(confirm("åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) db.ref('/').set({gameMaster:{phase:'waiting'}}); }
</script>
</body>
</html>
