<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å›šäººã®ã‚¸ãƒ¬ãƒ³ãƒ - è¡¨å½°å¼</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #1a1a2e; color: white; padding: 40px; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 30px; }
        .rank-card { background: #16213e; padding: 20px; border-radius: 15px; border: 2px solid #0f3460; }
        h2 { color: #e94560; border-bottom: 2px solid #e94560; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        td { padding: 10px; border-bottom: 1px solid #0f3460; text-align: left; }
        .gold { color: #f1c40f; font-weight: bold; }
        .silver { color: #bdc3c7; font-weight: bold; }
        .bronze { color: #cd7f32; font-weight: bold; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 5px; }
        .bg-peace { background: #27ae60; }
        .bg-cold { background: #c0392b; }
    </style>
</head>
<body>
    <h1>ğŸ“Š æœ€çµ‚ãƒªã‚¶ãƒ«ãƒˆãƒ»è¡¨å½°å¼</h1>
    <div class="grid">
        <div class="rank-card">
            <h2>åˆ‘æœŸãŒé•·ã„ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <p><small>ï¼ˆè£åˆ‡ã‚‰ã‚Œç¶šã‘ãŸä¸é‹ãªå›šäººï¼‰</small></p>
            <table id="worst-rank"></table>
        </div>

        <div class="rank-card">
            <h2>å¹³å’Œä¸»ç¾©ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <p><small>ï¼ˆä¸€åº¦ã‚‚è£åˆ‡ã‚‰ãªã‹ã£ãŸèª å®Ÿãªå›šäººï¼‰</small></p>
            <table id="peace-rank"></table>
        </div>

        <div class="rank-card">
            <h2>å†·å¾¹ãªæˆ¦ç•¥å®¶ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <p><small>ï¼ˆåˆç†çš„ã«è£åˆ‡ã‚Šã‚’é¸ã‚“ã å›šäººï¼‰</small></p>
            <table id="cold-rank"></table>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_lw01IiPvvBjinfw2UZ9NuqqurGm5yIw",
        authDomain: "prisonergame-27a20.firebaseapp.com",
        databaseURL: "https://prisonergame-27a20-default-rtdb.firebaseio.com",
        projectId: "prisonergame-27a20",
        storageBucket: "prisonergame-27a20.firebasestorage.app",
        messagingSenderId: "456926790656",
        appId: "1:456926790656:web:7e59a56e6a68ed612444e5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref().on('value', snapshot => {
        const data = snapshot.val();
        if (!data || !data.rooms || !data.presence) return;
        
        const rooms = data.rooms;
        const students = data.presence;
        let stats = {};

        // ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
        Object.keys(rooms).forEach(rId => {
            const room = rooms[rId];
            ['round1', 'round2'].forEach(rnd => {
                const g = room[rnd];
                if (g && g.p1_choice && g.p2_choice) {
                    const calc = (c1, c2) => (c1==="è‡ªç™½ã—ãªã„"&&c2==="è‡ªç™½ã—ãªã„"?2 : c1==="è‡ªç™½ã—ãªã„"&&c2==="è‡ªç™½ã™ã‚‹"?10 : c1==="è‡ªç™½ã™ã‚‹"&&c2==="è‡ªç™½ã—ãªã„"?0 : 5);
                    
                    [ {id: room.p1, c: g.p1_choice, op: g.p2_choice}, {id: room.p2, c: g.p2_choice, op: g.p1_choice} ].forEach(p => {
                        if (p.id === "CPU") return;
                        if (!stats[p.id]) stats[p.id] = { name: students[p.id].name, prison: 0, nonConfessCount: 0, confessCount: 0 };
                        stats[p.id].prison += calc(p.c, p.op);
                        if (p.c === "è‡ªç™½ã—ãªã„") stats[p.id].nonConfessCount++;
                        else stats[p.id].confessCount++;
                    });
                }
            });
        });

        const list = Object.values(stats);
        
        // 1. æ‡²å½¹ãƒ¯ãƒ¼ã‚¹ãƒˆ (åˆ‘æœŸé †)
        const worst = [...list].sort((a,b) => b.prison - a.prison).slice(0, 5);
        document.getElementById('worst-rank').innerHTML = worst.map((p,i) => `<tr><td class="${i===0?'gold':''}">${i+1}ä½</td><td>${p.name}</td><td>${p.prison}å¹´</td></tr>`).join('');

        // 2. å¹³å’Œä¸»ç¾© (è‡ªç™½ã—ãªã„ã‚«ã‚¦ãƒ³ãƒˆé †)
        const peace = list.filter(p => p.nonConfessCount >= 1).sort((a,b) => b.nonConfessCount - a.nonConfessCount).slice(0, 5);
        document.getElementById('peace-rank').innerHTML = peace.map((p,i) => `<tr><td>ğŸ•Šï¸</td><td>${p.name}</td><td><span class="badge bg-peace">${p.nonConfessCount}å›å”åŠ›</span></td></tr>`).join('');

        // 3. æˆ¦ç•¥å®¶ (è‡ªç™½ã™ã‚‹ã‚«ã‚¦ãƒ³ãƒˆé †)
        const cold = list.filter(p => p.confessCount >= 1).sort((a,b) => b.confessCount - a.confessCount).slice(0, 5);
        document.getElementById('cold-rank').innerHTML = cold.map((p,i) => `<tr><td>ğŸ˜ˆ</td><td>${p.name}</td><td><span class="badge bg-cold">${p.confessCount}å›è£åˆ‡ã‚Š</span></td></tr>`).join('');
    });
</script>
</body>
</html>
