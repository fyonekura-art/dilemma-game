<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å›šäººã®ã‚¸ãƒ¬ãƒ³ãƒ - å…¨å“¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #1a1a2e; color: white; padding: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px; align-items: start; }
        .rank-card { background: #16213e; padding: 15px; border-radius: 15px; border: 2px solid #0f3460; height: 85vh; overflow-y: auto; }
        h2 { color: #e94560; border-bottom: 2px solid #e94560; padding-bottom: 10px; position: sticky; top: 0; background: #16213e; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { padding: 8px 5px; border-bottom: 1px solid #0f3460; text-align: left; font-size: 0.9rem; }
        .rank-num { font-weight: bold; width: 35px; color: #888; }
        .gold { color: #f1c40f; font-size: 1.1rem; }
        .silver { color: #bdc3c7; }
        .bronze { color: #cd7f32; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: white; }
        .bg-peace { background: #27ae60; }
        .bg-cold { background: #c0392b; }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .rank-card::-webkit-scrollbar { width: 6px; }
        .rank-card::-webkit-scrollbar-thumb { background: #0f3460; border-radius: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ“Š æœ€çµ‚ãƒªã‚¶ãƒ«ãƒˆï¼ˆå‚åŠ è€…å…¨å“¡ï¼‰</h1>
    <p>â€»å¯¾æˆ¦ãŒå®Œäº†ã—ãŸäººã‹ã‚‰é †æ¬¡æ›´æ–°ã•ã‚Œã¾ã™</p>
    
    <div class="grid">
        <div class="rank-card">
            <h2>åˆ‘æœŸãƒ¯ãƒ¼ã‚¹ãƒˆ</h2>
            <table id="worst-rank"></table>
        </div>

        <div class="rank-card">
            <h2>å¹³å’Œä¸»ç¾©</h2>
            <table id="peace-rank"></table>
        </div>

        <div class="rank-card">
            <h2>å†·å¾¹ãªæˆ¦ç•¥å®¶</h2>
            <table id="cold-rank"></table>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_lw01IiPvvBjinfw2UZ9NuqqurGm5yIw",
        authDomain: "prisonergame-27a20.firebaseapp.com",
        databaseURL: "https://prisonergame-27a20-default-rtdb.firebaseio.com",
        projectId: "prisonergame-27a20",
        storageBucket: "prisonergame-27a20.firebasestorage.app",
        messagingSenderId: "456926790656",
        appId: "1:456926790656:web:7e59a56e6a68ed612444e5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    db.ref().on('value', snapshot => {
        const data = snapshot.val();
        if (!data || !data.rooms || !data.presence) return;
        
        const rooms = data.rooms;
        const students = data.presence;
        let stats = {};

        Object.keys(rooms).forEach(rId => {
            const room = rooms[rId];
            ['round1', 'round2'].forEach(rnd => {
                const g = room[rnd];
                if (g && g.p1_choice && g.p2_choice) {
                    const calc = (c1, c2) => (c1==="è‡ªç™½ã—ãªã„"&&c2==="è‡ªç™½ã—ãªã„"?2 : c1==="è‡ªç™½ã—ãªã„"&&c2==="è‡ªç™½ã™ã‚‹"?10 : c1==="è‡ªç™½ã™ã‚‹"&&c2==="è‡ªç™½ã—ãªã„"?0 : 5);
                    
                    [ {id: room.p1, c: g.p1_choice, op: g.p2_choice}, {id: room.p2, c: g.p2_choice, op: g.p1_choice} ].forEach(p => {
                        if (p.id === "CPU") return;
                        if (!stats[p.id]) stats[p.id] = { name: students[p.id]?.name || "ä¸æ˜", prison: 0, nonConfessCount: 0, confessCount: 0 };
                        stats[p.id].prison += calc(p.c, p.op);
                        if (p.c === "è‡ªç™½ã—ãªã„") stats[p.id].nonConfessCount++;
                        else stats[p.id].confessCount++;
                    });
                }
            });
        });

        const list = Object.values(stats);
        
        // 1. æ‡²å½¹ãƒ¯ãƒ¼ã‚¹ãƒˆï¼ˆå…¨å“¡ï¼‰
        const worst = [...list].sort((a,b) => b.prison - a.prison);
        document.getElementById('worst-rank').innerHTML = worst.map((p,i) => {
            let cls = i===0?'gold':i===1?'silver':i===2?'bronze':'';
            return `<tr><td class="rank-num ${cls}">${i+1}</td><td>${p.name}</td><td><b>${p.prison}å¹´</b></td></tr>`;
        }).join('');

        // 2. å¹³å’Œä¸»ç¾©ï¼ˆå…¨å“¡ï¼šè‡ªç™½ã—ãªã„å›æ•°é †ï¼‰
        const peace = [...list].sort((a,b) => b.nonConfessCount - a.nonConfessCount);
        document.getElementById('peace-rank').innerHTML = peace.map((p,i) => `<tr><td class="rank-num">${i+1}</td><td>${p.name}</td><td><span class="badge bg-peace">${p.nonConfessCount}å›å”åŠ›</span></td></tr>`).join('');

        // 3. æˆ¦ç•¥å®¶ï¼ˆå…¨å“¡ï¼šè‡ªç™½ã™ã‚‹å›æ•°é †ï¼‰
        const cold = [...list].sort((a,b) => b.confessCount - a.confessCount);
        document.getElementById('cold-rank').innerHTML = cold.map((p,i) => `<tr><td class="rank-num">${i+1}</td><td>${p.name}</td><td><span class="badge bg-cold">${p.confessCount}å›è£åˆ‡ã‚Š</span></td></tr>`).join('');
    });
</script>
</body>
</html>
